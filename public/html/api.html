<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LytoTec Abastecimentos</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            flex-direction: column;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        #login-form {
            max-width: 400px;
            margin: auto;
        }
        h2, h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 18px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
            font-size: 1em;
        }
        input[type="text"],
        input[type="password"],
        input[type="date"],
        select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e1e5eb;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            color: #333;
            background-color: #f9fafb;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.2);
            outline: none;
        }
        button {
            padding: 14px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        button:hover {
            background-color: #2980b9;
        }
        #message {
            text-align: center;
            margin-top: 20px;
            font-weight: 500;
            font-size: 0.9em;
        }
        .message-error {
            color: #e74c3c;
        }
        .message-success {
            color: #27ae60;
        }
        #data-display {
            background-color: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 1200px;
            box-sizing: border-box;
            display: none;
            margin-top: 20px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .filter-grid .form-group {
            margin-bottom: 0;
        }
        .search-button-container {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            padding-top: 10px;
        }
        .search-button-container button {
            min-width: 120px;
            padding: 10px 15px;
            font-size: 16px;
            width: auto;
        }
        
        /* Área de resultados */
        .results-area {
            margin-top: 20px;
            border-top: 1px solid #e1e5eb;
            padding-top: 20px;
        }
        #data-status {
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
        }
        /* --- Estilos para a exibição tabular --- */
        #abastecimentos-table-wrapper {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #e1e5eb;
            border-radius: 5px;
            background-color: #fff;
            margin-top: 20px;
            display: none;
        }
        #abastecimentos-table {
            display: grid;
            grid-template-columns: minmax(180px, 1fr) /* Identificador */
                                minmax(150px, 1fr) /* Tipo Procedimento */
                                minmax(130px, 1fr) /* Data Abast */
                                minmax(100px, 1fr) /* Hora Abast */
                                minmax(180px, 1fr) /* Comboista */
                                minmax(150px, 1fr) /* Operador */
                                minmax(120px, 1fr) /* Operação */
                                minmax(100px, 1fr) /* Frota */
                                minmax(100px, 1fr) /* Medidor */
                                minmax(150px, 1fr) /* Medidor Via Entrada */
                                minmax(150px, 1fr) /* Medidor Unidade */
                                minmax(80px, 1fr)  /* Bico */
                                minmax(120px, 1fr) /* Combustível */
                                minmax(100px, 1fr) /* Litragem */
                                minmax(150px, 1fr) /* Encerrante Final */
                                minmax(150px, 1fr) /* Cód. Terceiro */
                                minmax(120px, 1fr) /* Latitude */
                                minmax(120px, 1fr) /* Longitude */
                                minmax(150px, 1fr) /* Foto Verificada */
                                minmax(200px, 1fr) /* Identificação do Ponto */
                                minmax(100px, 1fr) /* Estoque */
                                minmax(160px, 1fr) /* Medidor Ant. Data */
                                minmax(160px, 1fr) /* Medidor Ant. Valor */
                                minmax(100px, 1fr) /* Placa */
                                minmax(150px, 1fr) /* Centro de Custo (CC) */
                                minmax(180px, 1fr) /* Registro Editado Em */
                                minmax(180px, 1fr) /* Registrado Editado Por */
                                minmax(120px, 1fr) /* Frota Tag */
                                minmax(120px, 1fr) /* Comboista Tag */
                                minmax(120px, 1fr) /* Operador Tag */
                                minmax(180px, 1fr); /* Data Integração */
            width: fit-content;
            min-width: 100%;
        }
        .table-header, .table-row {
            display: contents;
        }
        .table-header div, .table-cell {
            padding: 10px 8px;
            border-bottom: 1px solid #eef2f6;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table-header div {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .table-row:nth-child(even) .table-cell {
            background-color: #f9fafb;
        }
        .table-row:nth-child(odd) .table-cell {
            background-color: #ffffff;
        }
        
        .table-cell {
            font-size: 0.85em;
        }
        /* Controles de paginação */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
            display: none;
        }
        
        .pagination-button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            width: auto;
        }
        
        .pagination-button:hover {
            background-color: #2980b9;
        }
        
        .pagination-button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .page-size-selector select {
            width: auto;
            padding: 5px;
        }
        
        /* --- Estilos do Dashboard --- */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        .dashboard-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid;
            transition: transform 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-3px);
        }
        /* Cores das bordas dos cards */
        .summary-1 { border-left-color: #3498db; }
        .summary-2 { border-left-color: #2ecc71; }
        .summary-3 { border-left-color: #f39c12; }
        .summary-4 { border-left-color: #e23030; }
        .summary-5 { border-left-color: #27ae60; }
        .summary-text h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .summary-text p {
            color: #7f8c8d;
            font-size: 13px;
            margin: 0;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        @media (max-width: 900px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            .chart-card.full-width {
                grid-column: auto;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            height: 350px;
            display: flex;
            flex-direction: column;
            border: 1px solid #e1e5eb;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .chart-content {
            flex: 1;
            min-height: 280px;
            display: flex; /* Adicionado para centralizar a mensagem de "sem dados" */
            align-items: center; /* Adicionado para centralizar a mensagem de "sem dados" */
            justify-content: center; /* Adicionado para centralizar a mensagem de "sem dados" */
        }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tab-btn {
            background: #ecf0f1;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            background: #3498db;
            color: white;
        }
    </style>
</head>
<body>
    <div id="login-form" class="container">
        <h2>LytoTec Abastecimentos</h2>
        <div class="form-group">
            <label for="username">Usuário:</label>
            <input type="text" id="username" name="username" required value="testekorth@lytoranea">
        </div>
        <div class="form-group">
            <label for="password">Senha:</label>
            <input type="password" id="password" name="password" required value="0123456789">
        </div>
        <button id="loginButton">ACESSAR</button>
        <div id="message" class="message-error"></div>
    </div>
    <div id="data-display" class="container">
        <div class="dashboard-header">
            <h3>LytoTec-Abastecimentos</h3>
            <button id="toggleDashboard" class="btn" style="width: auto; padding: 10px 20px;">
                Ocultar Gráficos
            </button>
        </div>
        <div class="filter-grid">
            <div class="form-group">
                <label for="startDate">Data Inicial:</label>
                <input type="date" id="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">Data Final:</label>
                <input type="date" id="endDate" required>
            </div>
            <div class="form-group">
                <label for="comboista">Comboista:</label>
                <input type="text" id="comboista" placeholder="Nome do Comboista">
            </div>
            <div class="form-group">
                <label for="frota">Frota:</label>
                <input type="text" id="frota" placeholder="Código da Frota">
            </div>
            <div class="form-group">
                <label for="placa">Placa:</label>
                <input type="text" id="placa" placeholder="ABC1234">
            </div>
            <div class="form-group">
                <label for="cc">Centro de Custo (CC):</label>
                <input type="text" id="cc" placeholder="Código do CC">
            </div>
            <div class="form-group">
                <label for="limit">Resultados por página:</label>
                <select id="limit">
                    <option value="5" selected>5 Linhas</option>
                    <option value="10">10 Linhas</option>
                    <option value="20">20 Linhas</option>
                    <option value="30">30 Linhas</option>
                    <option value="50">50 Linhas</option>
                </select>
            </div>
            <div class="search-button-container">
                <button id="searchButton">Buscar</button>
            </div>
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card summary-1">
                    <div class="summary-text">
                        <h3 id="total-abastecimentos">0</h3>
                        <p>Total de Abastecimentos</p>
                    </div>
                </div>
                <div class="summary-card summary-2">
                    <div class="summary-text">
                        <h3 id="total-litros">0 L</h3>
                        <p>Litros Abastecidos</p>
                    </div>
                </div>
                <div class="summary-card summary-3">
                    <div class="summary-text">
                        <h3 id="total-frotas">0</h3>
                        <p>Frotas Ativas</p>
                    </div>
                </div>
                 <div class="summary-card summary-4">
                    <div class="summary-text">
                        <h3 id="avg-consumption-overall">0 km/L</h3>
                        <p>Consumo Médio Geral</p>
                    </div>
                </div>
                <div class="summary-card summary-5" id="totalKmRodadoCard" style="display: none;">
                    <div class="summary-text">
                        <h3 id="total-km-rodado">0 km</h3>
                        <p>Total KM Rodado (Filtrado)</p>
                    </div>
                </div>
                </div>
            
            <div class="charts-container">
                <div class="chart-card full-width" id="chartConsumoDiarioCard" style="display: none;">
                    <div class="chart-header">
                        <div class="chart-title">Consumo Médio por Veículo (km/L) Diário</div>
                        <div class="chart-info">
                            Exibido com filtros de Frota ou Placa
                        </div>
                    </div>
                    <div class="chart-content" id="chartConsumoDiario"></div>
                </div>
                
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Litragem Diária</div>
                        <div class="chart-tabs">
                            <button class="tab-btn active" data-period="daily">Diário</button>
                        </div>
                    </div>
                    <div class="chart-content" id="chartLitragem"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">Contagem de Abastecimentos Diários</div>
                    </div>
                    <div class="chart-content" id="chartAbastecimentosPorDia"></div>
                </div>
                
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">Litragem por Centro de Custo (CC)</div>
                    </div>
                    <div class="chart-content" id="chartLitragemPorCC"></div>
                </div>
                
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div class="chart-title">Abastecimentos por Comboista</div>
                    </div>
                    <div class="chart-content" id="chartAbastecimentosPorComboista"></div>
                </div>
            </div>
        </div>
        <div id="comparative-analysis-section" style="display: none;">
            <div class="container">
                <div class="dashboard-header">
                    <h3>Análise Comparativa de Frotas</h3>
                    <button id="toggleComparativeAnalysis" class="btn" style="width: auto; padding: 10px 20px;">
                        Ocultar Comparativo
                    </button>
                </div>
                <div id="comparative-content">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="frota1Compare">Frota 1:</label>
                            <input type="text" id="frota1Compare" placeholder="Código da Frota 1">
                        </div>
                        <div class="form-group">
                            <label for="frota2Compare">Frota 2:</label>
                            <input type="text" id="frota2Compare" placeholder="Código da Frota 2">
                        </div>
                        <div class="search-button-container">
                            <button id="compareFrotasButton">Gerar Comparativo</button>
                        </div>
                    </div>
                    <div class="chart-card full-width" style="height: 400px;">
                        <div class="chart-header">
                            <div class="chart-title">Litragem Total e Consumo Médio por Frota</div>
                        </div>
                        <div class="chart-content" id="chartComparativoFrotas"></div>
                    </div>
                    <p id="comparative-status" style="text-align: center; margin-top: 15px;"></p>
                </div>
            </div>
        </div>
        <div class="results-area">
            <p id="data-status">Use os filtros acima e clique em "Buscar" para carregar os dados.</p>
            <div id="abastecimentos-table-wrapper">
                <div id="abastecimentos-table">
                    <div class="table-header">
                        <div>Identificador</div>
                        <div>Tipo Procedimento</div>
                        <div>Data Abastecimento</div>
                        <div>Hora Abastecimento</div>
                        <div>Comboista</div>
                        <div>Operador</div>
                        <div>Operação</div>
                        <div>Frota</div>
                        <div>Medidor</div>
                        <div>Medidor Via Entrada</div>
                        <div>Medidor Unidade</div>
                        <div>Bico</div>
                        <div>Combustível</div>
                        <div>Litragem</div>
                        <div>Encerrante Final</div>
                        <div>Cód. Terceiro</div>
                        <div>Latitude</div>
                        <div>Longitude</div>
                        <div>Foto Verificada</div>
                        <div>Identificação do Ponto</div>
                        <div>Estoque</div>
                        <div>Medidor Ant. Data</div>
                        <div>Medidor Ant. Valor</div>
                        <div>Placa</div>
                        <div>Centro de Custo (CC)</div>
                        <div>Registro Editado Em</div>
                        <div>Registrado Editado Por</div>
                        <div>Frota Tag</div>
                        <div>Comboista Tag</div>
                        <div>Operador Tag</div>
                        <div>Data Integração</div>
                    </div>
                </div>
            </div>
            
            <div class="pagination-controls">
                <button id="prev-page" class="pagination-button">Anterior</button>
                <span id="page-info" class="pagination-info">Página 1 de 1</span>
                <button id="next-page" class="pagination-button">Próxima</button>
            </div>
        </div>
        <button id="logoutButton" style="background-color: #3498db; margin-top: 20px;">Sair</button>
    </div>
    <script>
        const LOCAL_PROXY_BASE_URL = "http://127.0.0.1:5000/api";
        const AUTH_ENDPOINT = `${LOCAL_PROXY_BASE_URL}/authenticate`;
        const ABASTECIMENTOS_ENDPOINT = `${LOCAL_PROXY_BASE_URL}/abastecimentos`;
        // Elementos do DOM
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const messageDiv = document.getElementById('message');
        const loginFormDiv = document.getElementById('login-form');
        const dataDisplayDiv = document.getElementById('data-display');
        const abastecimentosTableDiv = document.getElementById('abastecimentos-table');
        const dataStatusP = document.getElementById('data-status');
        const toggleDashboardBtn = document.getElementById('toggleDashboard');
        const dashboardContent = document.getElementById('dashboard-content');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const comboistaInput = document.getElementById('comboista');
        const frotaInput = document.getElementById('frota');
        const placaInput = document.getElementById('placa');
        const ccInput = document.getElementById('cc');
        const limitSelect = document.getElementById('limit');
        const searchButton = document.getElementById('searchButton');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');
        const pageInfoSpan = document.getElementById('page-info');
        const paginationControlsDiv = document.querySelector('.pagination-controls');
        const totalAbastecimentosEl = document.getElementById('total-abastecimentos');
        const totalLitrosEl = document.getElementById('total-litros');
        const totalFrotasEl = document.getElementById('total-frotas');
        const avgConsumptionOverallEl = document.getElementById('avg-consumption-overall'); 
        const totalKmRodadoEl = document.getElementById('total-km-rodado'); 
        const totalKmRodadoCard = document.getElementById('totalKmRodadoCard'); 
        const chartConsumoDiarioCard = document.getElementById('chartConsumoDiarioCard'); 
        const comparativeAnalysisSection = document.getElementById('comparative-analysis-section');
        const toggleComparativeAnalysisBtn = document.getElementById('toggleComparativeAnalysis');
        const frota1CompareInput = document.getElementById('frota1Compare');
        const frota2CompareInput = document.getElementById('frota2Compare');
        const compareFrotasButton = document.getElementById('compareFrotasButton');
        const comparativeStatusP = document.getElementById('comparative-status');
        // Variáveis globais
        let authToken = null;
        let allAbastecimentos = [];
        let filteredAbastecimentos = [];
        let currentPage = 1;
        let rowsPerPage = 5;
        let totalPages = 1;
        let chartLitragem = null;
        let chartConsumoDiario = null;
        let chartAbastecimentosPorDia = null;
        let chartLitragemPorCC = null;
        let chartAbastecimentosPorComboista = null;
        let chartComparativoFrotas = null;
        let showDashboard = true;
        let showComparative = false;
        // Mapeamento de comboistas
        const comboistaNames = {           
        };
        
        /**
         * Formata um número inteiro com separadores de milhar (ponto).
         * Exemplo: 1000000.5 -> "1.000.000"
         * @param {number} number - O número a ser formatado.
         * @returns {string} O número formatado como string.
         */
        function formatNumberWithCommas(number) {
            // Se não for número ou for nulo/indefinido, retorna '0'
            if (isNaN(number) || number === null || typeof number === 'undefined') return '0';
            // Arredonda para inteiro mais próximo
            const integer = Math.round(number);
            // Converte para string e aplica a regex para adicionar pontos como separadores de milhar
            return integer.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        /**
         * Exibe uma mensagem de "sem dados" em um elemento HTML especificado.
         * Esta função é usada para gráficos que não possuem dados para renderizar.
         * @param {string} elementId - O ID do elemento HTML onde a mensagem será exibida.
         * @param {string} [message="Nenhum dado disponível para este gráfico."] - A mensagem a ser exibida.
         * @returns {void}
         */
        function displayNoChartDataMessage(elementId, message = "Nenhum dado disponível para este gráfico.") {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div style="text-align: center; padding: 20px; color: #7f8c8d;">${message}</div>`;
            }
        }
        
        /**
         * Exibe uma mensagem na div de mensagens do formulário.
         * @param {string} msg - A mensagem a ser exibida.
         * @param {boolean} [isError=true] - Booleano indicando se a mensagem é um erro (true) ou sucesso (false).
         * @returns {void}
         */
        function showMessage(msg, isError = true) {
            messageDiv.textContent = msg;
            messageDiv.className = isError ? 'message-error' : 'message-success';
        }
        
        /**
         * Oculta o formulário de login e exibe a área de exibição de dados.
         * @returns {void}
         */
        function hideLoginShowData() {
            loginFormDiv.style.display = 'none';
            dataDisplayDiv.style.display = 'block';
        }
        
        /**
         * Oculta a área de exibição de dados e mostra o formulário de login.
         * Também reinicia o estado dos gráficos e da tabela.
         * @returns {void}
         */
        function showLoginHideData() {
            loginFormDiv.style.display = 'block';
            dataDisplayDiv.style.display = 'none';
            dataStatusP.textContent = 'Use os filtros acima e clique em "Buscar" para carregar os dados.';
            messageDiv.textContent = '';
            document.querySelector('#abastecimentos-table-wrapper').style.display = 'none';
            paginationControlsDiv.style.display = 'none';
            dashboardContent.style.display = 'none';
            comparativeAnalysisSection.style.display = 'none';
            
            // Destruir todos os gráficos para limpar o estado
            [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
             chartLitragemPorCC, chartAbastecimentosPorComboista, chartComparativoFrotas].forEach(chart => {
                if (chart) chart.destroy();
            });
        }
        
        /**
         * Formata um objeto Date para o formato "YYYY-MM-DD".
         * @param {Date} date - O objeto Date a ser formatado.
         * @returns {string} A data formatada como string.
         */
        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }
        
        /**
         * Atualiza o estado dos botões de paginação (anterior/próximo) e as informações da página atual.
         * @returns {void}
         */
        function updatePaginationControls() {
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = currentPage === totalPages;
            pageInfoSpan.textContent = `Página ${currentPage} de ${totalPages}`;
        }
        
        /**
         * Exibe os dados de abastecimento filtrados na tabela, aplicando a paginação atual.
         * Atualiza os controles de paginação.
         * @returns {void}
         */
        function displayPaginatedData() {
            const headerRow = document.querySelector('.table-header');
            abastecimentosTableDiv.innerHTML = ''; // Limpa a tabela
            abastecimentosTableDiv.appendChild(headerRow); // Adiciona o cabeçalho de volta
            
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredAbastecimentos.length);
            const paginatedData = filteredAbastecimentos.slice(startIndex, endIndex);
            console.log("Dados paginados para exibição (paginatedData):", paginatedData);
            
            if (paginatedData.length > 0) {
                paginatedData.forEach(abast => {
                    // Mapeamento de nomes para exibição na tabela
                    const comboistaId = abast.comboista?.toString() || '';
                    const comboistaDisplay = comboistaNames[comboistaId] || abast.comboista || 'N/A';
                    // Formatação de data e hora para exibição
                    const dataAbastecimentoFormatada = abast.data_abast ? new Date(abast.data_abast).toLocaleDateString('pt-BR') : 'N/A';
                    const horaAbastecimentoFormatada = abast.hora_abast ? abast.hora_abast.substring(0, 5) : 'N/A'; // HH:MM
                    const registroEditadoEmData = abast.registro_editado_em ? new Date(abast.registro_editado_em).toLocaleDateString('pt-BR') : 'N/A';
                    const registroEditadoEmHora = abast.registro_editado_em ? new Date(abast.registro_editado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                    const dataIntegracaoData = abast.data_integracao ? new Date(abast.data_integracao).toLocaleDateString('pt-BR') : 'N/A';
                    const dataIntegracaoHora = abast.data_integracao ? new Date(abast.data_integracao).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                    
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'table-row';
                    rowDiv.innerHTML = `
                        <div class="table-cell">${abast.identificador || 'N/A'}</div>
                        <div class="table-cell">${abast.tipo_procedimento || 'N/A'}</div>
                        <div class="table-cell">${dataAbastecimentoFormatada}</div>
                        <div class="table-cell">${horaAbastecimentoFormatada}</div>
                        <div class="table-cell">${comboistaDisplay}</div>
                        <div class="table-cell">${abast.operador || 'N/A'}</div>
                        <div class="table-cell">${abast.operacao || 'N/A'}</div>
                        <div class="table-cell">${abast.frota || 'N/A'}</div>
                        <div class="table-cell">${abast.medidor || 'N/A'}</div>
                        <div class="table-cell">${abast.medidor_via_entrada || 'N/A'}</div>
                        <div class="table-cell">${abast.medidor_unidade || 'N/A'}</div>
                        <div class="table-cell">${abast.bico || 'N/A'}</div>
                        <div class="table-cell">${abast.combustivel || 'N/A'}</div>
                        <div class="table-cell">${(parseFloat(abast.litragem) || 0).toFixed(2)}</div>
                        <div class="table-cell">${(parseFloat(abast.encerrante_fim) || 0).toFixed(2)}</div>
                        <div class="table-cell">${abast.codigo_terceiro || 'N/A'}</div>
                        <div class="table-cell">${(parseFloat(abast.latitude) || 0).toFixed(6)}</div>
                        <div class="table-cell">${(parseFloat(abast.longitude) || 0).toFixed(6)}</div>
                        <div class="table-cell">${abast.foto_verificada ? 'Sim' : 'Não'}</div>
                        <div class="table-cell">${abast.identificacao_do_ponto || 'N/A'}</div>
                        <div class="table-cell">${abast.estoque || 'N/A'}</div>
                        <div class="table-cell">${abast.medidor_anterior_data ? new Date(abast.medidor_anterior_data).toLocaleDateString('pt-BR') : 'N/A'}</div>
                        <div class="table-cell">${(parseFloat(abast.medidor_anterior_valor) || 0).toFixed(2)}</div>
                        <div class="table-cell">${abast.placa || 'N/A'}</div>
                        <div class="table-cell">${abast.cc || 'N/A'}</div>
                        <div class="table-cell">${registroEditadoEmData} ${registroEditadoEmHora}</div>
                        <div class="table-cell">${abast.registrado_editado_por || 'N/A'}</div>
                        <div class="table-cell">${abast.frota_tag || 'N/A'}</div>
                        <div class="table-cell">${abast.comboista_tag || 'N/A'}</div>
                        <div class="table-cell">${abast.operador_tag || 'N/A'}</div>
                        <div class="table-cell">${dataIntegracaoData} ${dataIntegracaoHora}</div>
                    `;
                    abastecimentosTableDiv.appendChild(rowDiv);
                });
                document.querySelector('#abastecimentos-table-wrapper').style.display = 'block';
                paginationControlsDiv.style.display = 'flex';
            } else {
                // Exibe mensagem de "Nenhum dado encontrado" se não houver dados paginados
                const noDataRow = document.createElement('div');
                noDataRow.className = 'table-row';
                noDataRow.innerHTML = `<div class="table-cell" style="grid-column: 1 / -1; text-align: center; padding: 20px;">Nenhum dado encontrado para os filtros aplicados.</div>`;
                abastecimentosTableDiv.appendChild(noDataRow);
                document.querySelector('#abastecimentos-table-wrapper').style.display = 'block';
                paginationControlsDiv.style.display = 'none';
            }
            
            totalPages = Math.ceil(filteredAbastecimentos.length / rowsPerPage);
            updatePaginationControls();
        }
        
        /**
         * Calcula métricas gerais (litragem total, KM total rodado, consumo médio geral)
         * para um subconjunto de abastecimentos.
         * @param {Array<Object>} subsetAbastecimentos - Um array de objetos de abastecimento.
         * @returns {Object} Um objeto contendo totalLiters, totalKm e avgConsumption.
         */
        function getMetricsForAbastecimentos(subsetAbastecimentos) {
            let totalLiters = 0;
            let totalKm = 0;
            const vehicleMedidorHistory = {}; // Para calcular KM rodado por veículo
            
            subsetAbastecimentos.forEach(abast => {
                const vehicleKey = abast.placa || abast.frota;
                const litragem = parseFloat(abast.litragem) || 0;
                const medidor = parseFloat(abast.medidor);
                const datetime = abast.data_abast && abast.hora_abast
                    ? new Date(`${abast.data_abast.split('T')[0]}T${abast.hora_abast}`)
                    : new Date();
                
                totalLiters += litragem;
                
                if (vehicleKey && !isNaN(medidor)) {
                    if (!vehicleMedidorHistory[vehicleKey]) {
                        vehicleMedidorHistory[vehicleKey] = [];
                    }
                    vehicleMedidorHistory[vehicleKey].push({ datetime, medidor });
                }
            });
            
            // Calcular KM rodado de forma mais robusta, considerando a sequência do medidor
            for (const vehicleKey in vehicleMedidorHistory) {
                const entries = vehicleMedidorHistory[vehicleKey];
                entries.sort((a, b) => a.datetime - b.datetime); // Garante a ordem cronológica
                
                let previousMedidorValid = null;
                for (let i = 0; i < entries.length; i++) {
                    const currentEntry = entries[i];
                    if (!isNaN(currentEntry.medidor)) {
                        if (previousMedidorValid !== null) {
                            const kmDriven = currentEntry.medidor - previousMedidorValid;
                            if (kmDriven > 0) totalKm += kmDriven; // Apenas adiciona se o medidor aumentou
                        }
                        previousMedidorValid = currentEntry.medidor;
                    }
                }
            }
            
            const avgConsumption = totalLiters > 0 ? totalKm / totalLiters : 0;
            
            return { totalLiters, totalKm, avgConsumption };
        }
        
        /**
         * Calcula a litragem total por Centro de Custo (CC) para um array de abastecimentos.
         * Retorna os 10 principais CCs ordenados por litragem.
         * @param {Array<Object>} abastecimentos - Um array de objetos de abastecimento.
         * @returns {Array<Object>} Um array de objetos { cc, litros } para os principais centros de custo.
         */
        function calculateLitragemPorCC(abastecimentos) {
            const litragemPorCC = {};
            
            abastecimentos.forEach(abast => {
                const cc = abast.cc || 'Sem CC';
                const litragem = parseFloat(abast.litragem) || 0;
                
                litragemPorCC[cc] = (litragemPorCC[cc] || 0) + litragem;
            });
            
            return Object.entries(litragemPorCC)
                .sort((a, b) => b[1] - a[1]) // Ordena do maior para o menor
                .slice(0, 10) // Pega os 10 primeiros
                .map(([cc, litros]) => ({ cc, litros }));
        }
        
        /**
         * Gera e atualiza os dados e a renderização de todos os gráficos do dashboard,
         * bem como os cards de resumo, com base nos abastecimentos filtrados.
         * @param {Array<Object>} abastecimentos - Um array de objetos de abastecimento filtrados.
         * @returns {void}
         */
        function generateCharts(abastecimentos) {
            const litragemDiaria = {};
            const abastecimentosPorDia = {};
            const abastecimentosPorComboista = {};
            
            abastecimentos.forEach(abast => {
                const litragem = parseFloat(abast.litragem) || 0;
                
                if (abast.data_abast) {
                    const data = abast.data_abast.split('T')[0]; // Pega apenas a data (YYYY-MM-DD)
                    litragemDiaria[data] = (litragemDiaria[data] || 0) + litragem;
                    abastecimentosPorDia[data] = (abastecimentosPorDia[data] || 0) + 1;
                }
                
                // Contar abastecimentos por comboista
                const comboistaId = abast.comboista?.toString() || 'N/A';
                const comboistaName = comboistaNames[comboistaId] || comboistaId; // Usa o nome mapeado, se existir
                abastecimentosPorComboista[comboistaName] = (abastecimentosPorComboista[comboistaName] || 0) + 1;
            });
            
            // Calcula o consumo diário por veículo/frota
            const consumptionAnalysisDaily = calculateDailyFuelConsumption(abastecimentos);
            // Calcula a litragem por centro de custo
            const litragemPorCC = calculateLitragemPorCC(abastecimentos);
            
            // Prepara dados para o gráfico de comboistas
            const comboistaChartData = Object.entries(abastecimentosPorComboista)
                .sort((a, b) => b[1] - a[1]) // Ordena do maior para o menor
                .slice(0, 10) // Pega os 10 principais
                .map(([comboista, count]) => ({ comboista, count }));
            
            // Calcula o total de frotas ativas (únicas)
            let totalFrotas = new Set();
            abastecimentos.forEach(abast => abast.frota && totalFrotas.add(abast.frota));
            
            // Obtém métricas gerais para atualização dos cards de resumo
            const overallMetrics = getMetricsForAbastecimentos(abastecimentos);
            
            // Atualizar os cards de resumo com formatação
            totalAbastecimentosEl.textContent = abastecimentos.length.toLocaleString('pt-BR'); // Formatação brasileira (ponto como separador de milhar)
            totalLitrosEl.textContent = formatNumberWithCommas(overallMetrics.totalLiters) + ' L'; // Formata com pontos e 'L'
            totalFrotasEl.textContent = totalFrotas.size; // Não precisa de formatação de milhar, número geralmente pequeno
            avgConsumptionOverallEl.textContent = `${overallMetrics.avgConsumption.toFixed(2)} km/L`; // Mantém 2 casas decimais
            totalKmRodadoEl.textContent = `${formatNumberWithCommas(overallMetrics.totalKm)} km`; // Formata com pontos e 'km'
            
            // Converter dados diários para o formato do ApexCharts
            const litragemDiariaChartData = Object.entries(litragemDiaria)
                .map(([date, litros]) => ({ x: date, y: litros }))
                .sort((a, b) => new Date(a.x) - new Date(b.x));
            const abastecimentosPorDiaChartData = Object.entries(abastecimentosPorDia)
                .map(([date, count]) => ({ x: date, y: count }))
                .sort((a, b) => new Date(a.x) - new Date(b.x));
            
            // Renderiza todos os gráficos
            renderCharts(
                litragemDiariaChartData,
                consumptionAnalysisDaily,
                abastecimentosPorDiaChartData,
                litragemPorCC,
                comboistaChartData
            );
        }
        
        /**
         * Renderiza (ou re-renderiza) os gráficos do dashboard usando a biblioteca ApexCharts.
         * Destrói instâncias de gráficos existentes antes de criar novas.
         * @param {Array<Object>} litragemData - Dados para o gráfico de litragem diária.
         * @param {Array<Object>} consumptionAnalysisDailyData - Dados para o gráfico de consumo médio diário por veículo.
         * @param {Array<Object>} abastecimentosPorDiaData - Dados para o gráfico de contagem de abastecimentos diários.
         * @param {Array<Object>} litragemPorCCData - Dados para o gráfico de litragem por centro de custo.
         * @param {Array<Object>} comboistaChartData - Dados para o gráfico de abastecimentos por comboista.
         * @returns {void}
         */
        function renderCharts(litragemData, consumptionAnalysisDailyData, abastecimentosPorDiaData, litragemPorCCData, comboistaChartData) {
            // Destruir gráficos existentes para evitar duplicação e problemas de atualização
            [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
             chartLitragemPorCC, chartAbastecimentosPorComboista].forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Definição de paletas de cores para os gráficos
            const blueColors = ['#007bff', '#4285F4', '#1E90FF', '#6495ED', '#87CEEB', '#ADD8E6', '#4682B4', '#5F9EA0'];
            const greenColors = ['#28a745', '#218838', '#1e7e34'];
            const yellowcolors = ['#DFC57B'];

            // Gráfico de Litragem Diária
            if (litragemData.length > 0) {
                chartLitragem = new ApexCharts(document.querySelector("#chartLitragem"), {
                    series: [{ name: "Litros", data: litragemData }],
                    chart: { height: '100%', type: 'line', zoom: { enabled: false }, toolbar: { show: false } },
                    colors: [blueColors[2]], 
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    markers: { size: 5 },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#777', fontSize: '12px' } } },
                    yaxis: { title: { text: 'Litros', style: { color: '#777', fontSize: '12px' } }, labels: { style: { colors: '#777', fontSize: '12px' } } },
                    grid: { borderColor: '#f1f3f4' },
                    tooltip: { x: { format: 'dd MMM yyyy' }, y: { formatter: val => val.toFixed(0) + " litros" } }
                });
                chartLitragem.render();
            } else {
                displayNoChartDataMessage('chartLitragem', 'Não há dados de litragem para o período selecionado.');
            }
            
            // Gráfico de Consumo Médio por Veículo Diário (condicionalmente exibido)
            const hasConsumptionData = consumptionAnalysisDailyData.some(s => s.data && s.data.some(d => d.y !== null));
            if (hasConsumptionData) {
                chartConsumoDiario = new ApexCharts(document.querySelector("#chartConsumoDiario"), {
                    series: consumptionAnalysisDailyData, 
                    chart: { height: '100%', type: 'line', zoom: { enabled: false }, toolbar: { show: false } },
                    colors: blueColors, 
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    markers: { size: 5 },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#777', fontSize: '12px' } } },
                    yaxis: { title: { text: 'Consumo (km/L)', style: { color: '#777', fontSize: '12px' } }, labels: { formatter: val => val ? val.toFixed(2) : 'N/A', style: { colors: '#777', fontSize: '12px' } } },
                    grid: { borderColor: '#f1f3f4' },
                    tooltip: { x: { format: 'dd MMM yyyy' }, y: { formatter: val => val ? val.toFixed(2) + " km/L" : 'N/A' } }
                });
                chartConsumoDiario.render();
            } else {
                displayNoChartDataMessage('chartConsumoDiario', 'Não há dados de consumo para os filtros de veículo aplicados.');
            }
            
            // Gráfico de Contagem de Abastecimentos Diários
            if (abastecimentosPorDiaData.length > 0) {
                chartAbastecimentosPorDia = new ApexCharts(document.querySelector("#chartAbastecimentosPorDia"), {
                    series: [{ name: "Abastecimentos", data: abastecimentosPorDiaData }],
                    chart: { height: '100%', type: 'line', zoom: { enabled: false }, toolbar: { show: false } },
                    colors: ['#e23030'],
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    markers: { size: 5 },
                    xaxis: { type: 'datetime', labels: { style: { colors: '#777', fontSize: '12px' } } },
                    yaxis: { title: { text: 'Número de Abastecimentos', style: { color: '#777', fontSize: '12px' } }, labels: { formatter: val => val.toFixed(0), style: { colors: '#777', fontSize: '12px' } } },
                    grid: { borderColor: '#f1f3f4' },
                    tooltip: { x: { format: 'dd MMM yyyy' }, y: { formatter: val => val.toFixed(0) + " abastecimentos" } }
                });
                chartAbastecimentosPorDia.render();
            } else {
                displayNoChartDataMessage('chartAbastecimentosPorDia', 'Não há dados de abastecimentos diários para o período selecionado.');
            }
            
            // Gráfico: Litragem por Centro de Custo
            if (litragemPorCCData.length > 0) {
                chartLitragemPorCC = new ApexCharts(document.querySelector("#chartLitragemPorCC"), {
                    series: [{ name: 'Litros', data: litragemPorCCData.map(item => item.litros) }],
                    chart: { type: 'bar', height: '100%', toolbar: { show: false } },
                    plotOptions: { bar: { horizontal: false, columnWidth: '70%', endingShape: 'rounded' } },
                    dataLabels: { enabled: true, formatter: val => val.toFixed(0), style: { colors: ['#fff'] } },
                    xaxis: { 
                        categories: litragemPorCCData.map(item => item.cc),
                        labels: { 
                            style: { colors: '#777', fontSize: '12px' },
                            rotate: -45, // Rotação para melhor visualização de categorias longas
                            rotateAlways: true
                        }
                    },
                    yaxis: { 
                        title: { text: 'Litros', style: { color: '#777', fontSize: '12px' } },
                        labels: { style: { colors: '#777', fontSize: '12px' } }
                    },
                    colors: ['#F4C50B'],
                    tooltip: { y: { formatter: val => val.toFixed(0) + " litros" } }
                });
                chartLitragemPorCC.render();
            } else {
                displayNoChartDataMessage('chartLitragemPorCC', 'Não há dados de litragem por Centro de Custo.');
            }
            
            // Gráfico: Abastecimentos por Comboista
            if (comboistaChartData.length > 0) {
                chartAbastecimentosPorComboista = new ApexCharts(document.querySelector("#chartAbastecimentosPorComboista"), {
                    series: [{
                        name: "Abastecimentos",
                        data: comboistaChartData.map(item => item.count)
                    }],
                    chart: {
                        type: 'bar',
                        height: '100%',
                        toolbar: { show: false }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: true, // Barras horizontais para nomes de comboistas
                        }
                    },
                    colors: ['#4285F4'],
                    dataLabels: {
                        enabled: true,
                        formatter: function(val) {
                            return val.toFixed(0);
                        },
                        style: {
                            fontSize: '12px',
                            colors: ["#fff"]
                        }
                    },
                    xaxis: {
                        categories: comboistaChartData.map(item => item.comboista),
                        title: {
                            text: 'Número de Abastecimentos',
                            style: {
                                color: '#777',
                                fontSize: '12px'
                            }
                        },
                        labels: {
                            style: {
                                colors: '#777',
                                fontSize: '12px'
                            }
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                colors: '#777',
                                fontSize: '12px'
                            }
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function(val) {
                                return val + " abastecimentos";
                            }
                        }
                    }
                });
                chartAbastecimentosPorComboista.render();
            } else {
                displayNoChartDataMessage('chartAbastecimentosPorComboista', 'Não há dados de abastecimentos por Comboista.');
            }
        }
        
        /**
         * Calcula o consumo de combustível diário (km/L) para cada veículo/frota
         * dentro de um conjunto de abastecimentos.
         * Leva em conta a sequência dos medidores para calcular a distância percorrida.
         * @param {Array<Object>} abastecimentos - Um array de objetos de abastecimento.
         * @returns {Array<Object>} Um array de séries para o ApexCharts, contendo o nome do veículo/frota e os dados de consumo diário.
         */
        function calculateDailyFuelConsumption(abastecimentos) {
            const vehicleDailyData = {}; // Para armazenar km rodado e litros consumidos por veículo por dia
            const groupedByVehicle = {}; // Agrupa os abastecimentos por veículo/frota
            
            // Agrupamento inicial dos abastecimentos por veículo
            abastecimentos.forEach(abast => {
                const vehicleKey = abast.placa || abast.frota; // Usa placa ou frota como identificador do veículo
                if (!vehicleKey) return; // Ignora se não há identificador de veículo
                
                groupedByVehicle[vehicleKey] = groupedByVehicle[vehicleKey] || [];
                
                // Constrói a data/hora corretamente para ordenação
                const datetime = abast.data_abast && abast.hora_abast
                    ? new Date(`${abast.data_abast.split('T')[0]}T${abast.hora_abast}`)
                    : new Date();
                    
                groupedByVehicle[vehicleKey].push({
                    datetime,
                    date: abast.data_abast.split('T')[0],
                    medidor: parseFloat(abast.medidor),
                    litragem: parseFloat(abast.litragem)
                });
            });
            
            // Calcula o KM rodado e o consumo de litros por dia para cada veículo
            for (const vehicleKey in groupedByVehicle) {
                const entries = groupedByVehicle[vehicleKey];
                entries.sort((a, b) => a.datetime - b.datetime); // Ordena cronologicamente
                
                vehicleDailyData[vehicleKey] = {}; // Inicializa o objeto para cada veículo
                let previousMedidorValid = null;
                
                for (let i = 0; i < entries.length; i++) {
                    const currentEntry = entries[i];
                    const currentDate = currentEntry.date;
                    
                    if (!vehicleDailyData[vehicleKey][currentDate]) {
                        vehicleDailyData[vehicleKey][currentDate] = { km_driven: 0, liters_consumed: 0 };
                    }
                    
                    if (!isNaN(currentEntry.medidor)) {
                        if (previousMedidorValid !== null) {
                            const kmDriven = currentEntry.medidor - previousMedidorValid;
                            // Se o KM aumentou e houve litragem válida, adiciona ao total do dia
                            if (kmDriven > 0 && !isNaN(currentEntry.litragem) && currentEntry.litragem > 0) {
                                vehicleDailyData[vehicleKey][currentDate].km_driven += kmDriven;
                                vehicleDailyData[vehicleKey][currentDate].liters_consumed += currentEntry.litragem;
                            }
                        }
                        previousMedidorValid = currentEntry.medidor;
                    }
                }
            }
            
            const chartSeries = [];
            // Obtém todas as datas únicas para garantir que todos os veículos tenham pontos de dados para todas as datas
            const uniqueDates = [...new Set(abastecimentos.map(abast => abast.data_abast.split('T')[0]))]
                                .sort((a, b) => new Date(a) - new Date(b));
            
            // Monta as séries para o gráfico
            for (const vehicleKey in vehicleDailyData) {
                const dataPoints = uniqueDates.map(date => {
                    const dailyStats = vehicleDailyData[vehicleKey][date];
                    let kmPerLiter = null; 
                    if (dailyStats && dailyStats.liters_consumed > 0) {
                        kmPerLiter = dailyStats.km_driven / dailyStats.liters_consumed;
                    }
                    return {
                        x: new Date(date).getTime(), // ApexCharts usa timestamp para eixo de tempo
                        y: kmPerLiter ? parseFloat(kmPerLiter.toFixed(2)) : null // Formata para 2 casas decimais ou null
                    };
                });
                chartSeries.push({ name: vehicleKey, data: dataPoints });
            }
            return chartSeries;
        } 
        
        /**
         * Renderiza o gráfico de análise comparativa de frotas, exibindo a litragem total
         * e o consumo médio para as duas frotas especificadas.
         * @returns {void}
         */
        function renderComparativeChart() {
            if (chartComparativoFrotas) chartComparativoFrotas.destroy(); // Destroi gráfico anterior, se existir
            
            const frota1Code = frota1CompareInput.value.trim().toUpperCase();
            const frota2Code = frota2CompareInput.value.trim().toUpperCase();
            
            if (!frota1Code && !frota2Code) {
                comparativeStatusP.textContent = "Por favor, insira pelo menos um código de Frota para comparar.";
                return;
            }
            
            comparativeStatusP.textContent = "Gerando comparativo...";
            
            // Filtra os dados para cada frota
            const dataFrota1 = frota1Code ? allAbastecimentos.filter(abast => abast.frota && abast.frota.toUpperCase() === frota1Code) : [];
            const dataFrota2 = frota2Code ? allAbastecimentos.filter(abast => abast.frota && abast.frota.toUpperCase() === frota2Code) : [];
            
            // Calcula as métricas para cada frota
            const metricsFrota1 = getMetricsForAbastecimentos(dataFrota1);
            const metricsFrota2 = getMetricsForAbastecimentos(dataFrota2);
            
            const categories = [];
            const seriesLitragem = [];
            const seriesConsumo = [];
            
            // Popula os arrays de dados para o gráfico
            if (frota1Code) {
                categories.push(`Frota ${frota1Code}`);
                seriesLitragem.push(metricsFrota1.totalLiters);
                seriesConsumo.push(metricsFrota1.avgConsumption);
            }
            if (frota2Code) {
                categories.push(`Frota ${frota2Code}`);
                seriesLitragem.push(metricsFrota2.totalLiters);
                seriesConsumo.push(metricsFrota2.avgConsumption);
            }
            
            if (categories.length === 0) {
                comparativeStatusP.textContent = "Nenhum dado encontrado para as frotas especificadas nas datas filtradas.";
                return;
            }
            
            // Opções do gráfico ApexCharts
            const options = {
                series: [
                    { name: 'Litragem Total (L)', data: seriesLitragem },
                    { name: 'Consumo Médio (km/L)', data: seriesConsumo }
                ],
                chart: { type: 'bar', height: '100%', toolbar: { show: false } },
                plotOptions: { bar: { horizontal: false, columnWidth: '55%', endingShape: 'rounded' } },
                dataLabels: { enabled: false },
                stroke: { show: true, width: 2, colors: ['transparent'] },
                xaxis: { categories: categories, labels: { style: { colors: '#777', fontSize: '12px' } } },
                yaxis: [
                    { title: { text: 'Litragem (L)', style: { color: '#777', fontSize: '12px' } }, labels: { formatter: val => val.toFixed(0), style: { colors: '#777', fontSize: '12px' } } },
                    { opposite: true, title: { text: 'Consumo (km/L)', style: { color: '#777', fontSize: '12px' } }, labels: { formatter: val => val.toFixed(2), style: { colors: '#777', fontSize: '12px' } } }
                ],
                fill: { opacity: 1 },
                tooltip: { y: { formatter: (val, { seriesIndex }) => seriesIndex === 0 ? val.toFixed(0) + " litros" : val.toFixed(2) + " km/L" } },
                colors: ['#007bff', '#6495ED'],
                legend: { position: 'top', horizontalAlign: 'right', fontSize: '14px', labels: { colors: '#555' } },
                grid: { borderColor: '#f1f3f4' }
            };
            
            chartComparativoFrotas = new ApexCharts(document.querySelector("#chartComparativoFrotas"), options);
            chartComparativoFrotas.render();
            comparativeStatusP.textContent = "Comparativo gerado com sucesso.";
        }
        
        /**
         * Autentica o usuário com a API de autenticação.
         * @param {string} username - O nome de usuário para autenticação.
         * @param {string} password - A senha para autenticação.
         * @returns {Promise<boolean>} Retorna true se a autenticação for bem-sucedida, false caso contrário.
         */
        async function authenticate(username, password) {
            showMessage('Autenticando...', false);
            try {
                const response = await fetch(AUTH_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ login: username, senha: password })
                });
                const data = await response.json();
                if (response.ok && data.dados?.token) {
                    authToken = data.dados.token;
                    showMessage('Login bem-sucedido!', false);
                    return true;
                } else {
                    const errorMessage = data.erros?.join(', ') || 'Credenciais inválidas ou erro desconhecido.';
                    showMessage(`Falha no login: ${errorMessage}`);
                    return false;
                }
            } catch (error) {
                showMessage(`Erro de rede ao autenticar: ${error.message}`);
                return false;
            }
        }
        
        /**
         * Busca os dados de abastecimento da API e os filtra com base nos critérios de entrada.
         * Atualiza a tabela e os gráficos do dashboard com os dados filtrados.
         * @returns {Promise<void>}
         */
        async function fetchAndFilterAbastecimentos() {
            if (!authToken) {
                showMessage('Token de autenticação não encontrado. Faça login novamente.');
                return;
            }
            
            const dataIni = startDateInput.value;
            const dataFim = endDateInput.value;
            
            if (!dataIni || !dataFim) {
                dataStatusP.textContent = 'Por favor, selecione as datas inicial e final.';
                // Esconde as seções de dados e gráficos
                document.querySelector('#abastecimentos-table-wrapper').style.display = 'none';
                paginationControlsDiv.style.display = 'none';
                dashboardContent.style.display = 'none';
                comparativeAnalysisSection.style.display = 'none';
                return;
            }
            
            dataStatusP.textContent = 'Carregando dados...';
            // Esconde as seções enquanto carrega
            document.querySelector('#abastecimentos-table-wrapper').style.display = 'none';
            paginationControlsDiv.style.display = 'none';
            dashboardContent.style.display = 'none';
            comparativeAnalysisSection.style.display = 'none';
            
            // Prepara os parâmetros da requisição para a API
            const params = new URLSearchParams({
                dataIni: dataIni,
                dataFim: dataFim,
                referencia: 'data_abast',
                allData: 'true', // Indica para buscar todos os dados dentro do período
                limit: 10000 // Limite alto para buscar dados suficientes para gráficos
            });
            
            try {
                const response = await fetch(`${ABASTECIMENTOS_ENDPOINT}?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const data = await response.json();
                console.log("Resposta da API de abastecimentos:", data);
                
                if (response.ok && data.dados) {
                    allAbastecimentos = data.dados; // Armazena todos os abastecimentos brutos
                    
                    // Coleta os valores dos filtros
                    const comboistaFilter = comboistaInput.value.trim();
                    const frotaFilter = frotaInput.value.trim();
                    const placaFilter = placaInput.value.trim();
                    const ccFilter = ccInput.value.trim();
                    
                    // Filtra os abastecimentos com base nos critérios do usuário
                    filteredAbastecimentos = allAbastecimentos.filter(abast => {
                        const comboistaId = abast.comboista?.toString() || '';
                        const comboistaName = comboistaNames[comboistaId] || comboistaId; // Usa nome mapeado
                        
                        const comboistaMatches = !comboistaFilter || 
                            comboistaName.toUpperCase().includes(comboistaFilter.toUpperCase());
                            
                        const matchesFrota = !frotaFilter || (abast.frota && abast.frota.toString().toUpperCase().includes(frotaFilter.toUpperCase()));
                        const matchesPlaca = !placaFilter || (abast.placa && abast.placa.toString().toUpperCase().includes(placaFilter.toUpperCase()));
                        const matchesCc = !ccFilter || (abast.cc && abast.cc.toString().toUpperCase().includes(ccFilter.toUpperCase()));
                        
                        return comboistaMatches && matchesFrota && matchesPlaca && matchesCc;
                    });
                    
                    console.log("Dados após filtragem (filteredAbastecimentos):", filteredAbastecimentos);
                    
                    if (filteredAbastecimentos.length > 0) {
                        dataStatusP.textContent = `Foram encontrados ${filteredAbastecimentos.length} abastecimentos.`;
                        currentPage = 1;
                        rowsPerPage = parseInt(limitSelect.value);
                        displayPaginatedData(); // Exibe os dados paginados na tabela
                        
                        // Mostra e gera os gráficos do dashboard
                        dashboardContent.style.display = 'block';
                        generateCharts(filteredAbastecimentos);
                        
                        // Controla a exibição de cards/gráficos específicos de veículo/frota
                        const showFilteredVehicleDetails = frotaInput.value.trim() || placaInput.value.trim();
                        chartConsumoDiarioCard.style.display = showFilteredVehicleDetails ? 'flex' : 'none';
                        totalKmRodadoCard.style.display = showFilteredVehicleDetails ? 'flex' : 'none';
                    } else {
                        // Se nenhum dado for encontrado após a filtragem
                        dataStatusP.textContent = `Nenhum abastecimento encontrado para os filtros selecionados.`;
                        filteredAbastecimentos = []; // Limpa os dados filtrados
                        displayPaginatedData(); // Renderiza a tabela vazia
                        
                        // Zera os valores dos cards de resumo, aplicando a formatação
                        totalAbastecimentosEl.textContent = (0).toLocaleString('pt-BR');
                        totalLitrosEl.textContent = formatNumberWithCommas(0) + ' L';
                        totalFrotasEl.textContent = '0'; // Não precisa de formatação para 0 frotas
                        avgConsumptionOverallEl.textContent = '0.00 km/L';
                        totalKmRodadoEl.textContent = formatNumberWithCommas(0) + ' km';
                        chartConsumoDiarioCard.style.display = 'none';
                        totalKmRodadoCard.style.display = 'none';
                        
                        // Destrói e exibe mensagem de "sem dados" para todos os gráficos
                        [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
                         chartLitragemPorCC, chartAbastecimentosPorComboista, chartComparativoFrotas].forEach(chart => {
                            if (chart) chart.destroy();
                        });
                        displayNoChartDataMessage('chartLitragem', 'Não há dados para exibir.');
                        displayNoChartDataMessage('chartAbastecimentosPorDia', 'Não há dados para exibir.');
                        displayNoChartDataMessage('chartLitragemPorCC', 'Não há dados para exibir.');
                        displayNoChartDataMessage('chartAbastecimentosPorComboista', 'Não há dados para exibir.');
                        displayNoChartDataMessage('chartConsumoDiario', 'Não há dados para exibir.');
                    }
                } else {
                    // Trata erros da resposta da API
                    const errorMessage = data.erros?.join(', ') || 'Erro ao carregar dados.';
                    dataStatusP.textContent = `Erro: ${errorMessage}`;
                    // Limpa e zera o estado em caso de erro, aplicando a formatação
                    filteredAbastecimentos = [];
                    displayPaginatedData();
                    totalAbastecimentosEl.textContent = (0).toLocaleString('pt-BR');
                    totalLitrosEl.textContent = formatNumberWithCommas(0) + ' L';
                    totalFrotasEl.textContent = '0';
                    avgConsumptionOverallEl.textContent = '0.00 km/L';
                    totalKmRodadoEl.textContent = formatNumberWithCommas(0) + ' km';
                    chartConsumoDiarioCard.style.display = 'none';
                    totalKmRodadoCard.style.display = 'none';
                    [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
                     chartLitragemPorCC, chartAbastecimentosPorComboista, chartComparativoFrotas].forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    displayNoChartDataMessage('chartLitragem', 'Erro ao carregar dados.');
                    displayNoChartDataMessage('chartAbastecimentosPorDia', 'Erro ao carregar dados.');
                    displayNoChartDataMessage('chartLitragemPorCC', 'Erro ao carregar dados.');
                    displayNoChartDataMessage('chartAbastecimentosPorComboista', 'Erro ao carregar dados.');
                    displayNoChartDataMessage('chartConsumoDiario', 'Erro ao carregar dados.');
                }
            } catch (error) {
                // Trata erros de rede
                dataStatusP.textContent = `Erro de rede: ${error.message}`;
                // Limpa e zera o estado em caso de erro de rede, aplicando a formatação
                filteredAbastecimentos = [];
                displayPaginatedData();
                totalAbastecimentosEl.textContent = (0).toLocaleString('pt-BR');
                totalLitrosEl.textContent = formatNumberWithCommas(0) + ' L';
                totalFrotasEl.textContent = '0';
                avgConsumptionOverallEl.textContent = '0.00 km/L';
                totalKmRodadoEl.textContent = formatNumberWithCommas(0) + ' km';
                chartConsumoDiarioCard.style.display = 'none';
                totalKmRodadoCard.style.display = 'none';
                [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
                 chartLitragemPorCC, chartAbastecimentosPorComboista, chartComparativoFrotas].forEach(chart => {
                    if (chart) chart.destroy();
                });
                displayNoChartDataMessage('chartLitragem', 'Erro de rede.');
                displayNoChartDataMessage('chartAbastecimentosPorDia', 'Erro de rede.');
                displayNoChartDataMessage('chartLitragemPorCC', 'Erro de rede.');
                displayNoChartDataMessage('chartAbastecimentosPorComboista', 'Erro de rede.');
                displayNoChartDataMessage('chartConsumoDiario', 'Erro de rede.');
            }
        }
        
        // Event Listeners
        loginButton.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            if (!username || !password) {
                showMessage('Por favor, preencha todos os campos.');
                return;
            }
            if (await authenticate(username, password)) {
                hideLoginShowData();
                // Define as datas padrão para os últimos 90 dias após o login bem-sucedido
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(endDate.getDate() - 90);
                startDateInput.value = formatDate(startDate);
                endDateInput.value = formatDate(endDate);
            }
        });
        
        searchButton.addEventListener('click', fetchAndFilterAbastecimentos);
        
        limitSelect.addEventListener('change', () => {
            rowsPerPage = parseInt(limitSelect.value);
            currentPage = 1; // Volta para a primeira página ao mudar o limite
            displayPaginatedData();
        });
        
        logoutButton.addEventListener('click', () => {
            authToken = null; // Limpa o token de autenticação
            showMessage('Sessão encerrada.', false);
            showLoginHideData(); // Volta para a tela de login
            // Limpa os campos do formulário e o estado
            usernameInput.value = '';
            passwordInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            comboistaInput.value = '';
            frotaInput.value = '';
            placaInput.value = '';
            ccInput.value = '';
            limitSelect.value = '5';
            allAbastecimentos = [];
            filteredAbastecimentos = [];
            currentPage = 1;
            totalPages = 1;
            showDashboard = true; // Reseta o estado do dashboard
            showComparative = false; // Reseta o estado do comparativo
            toggleDashboardBtn.innerHTML = 'Ocultar Gráficos';
            toggleComparativeAnalysisBtn.innerHTML = 'Mostrar Comparativo';
        });
        
        // Controles de Paginação
        prevPageButton.addEventListener('click', () => currentPage > 1 && (currentPage--, displayPaginatedData()));
        nextPageButton.addEventListener('click', () => currentPage < totalPages && (currentPage++, displayPaginatedData()));
        
        // Alternar visibilidade do Dashboard
        toggleDashboardBtn.addEventListener('click', () => {
            showDashboard = !showDashboard;
            toggleDashboardBtn.innerHTML = showDashboard ? 'Ocultar Gráficos' : 'Mostrar Gráficos';
            dashboardContent.style.display = showDashboard ? 'block' : 'none';
            
            if (showDashboard && filteredAbastecimentos.length > 0) {
                generateCharts(filteredAbastecimentos); // Regenera gráficos se for exibido e houver dados
                // Atualiza a visibilidade dos cards/gráficos específicos de veículo/frota
                const showFilteredVehicleDetails = frotaInput.value.trim() || placaInput.value.trim();
                chartConsumoDiarioCard.style.display = showFilteredVehicleDetails ? 'flex' : 'none';
                totalKmRodadoCard.style.display = showFilteredVehicleDetails ? 'flex' : 'none';
            } else if (!showDashboard) {
                // Destroi gráficos se o dashboard for ocultado
                [chartLitragem, chartConsumoDiario, chartAbastecimentosPorDia, 
                 chartLitragemPorCC, chartAbastecimentosPorComboista, chartComparativoFrotas].forEach(chart => {
                    if (chart) chart.destroy();
                });
            }
        });
        
        // Alternar visibilidade da Análise Comparativa
        toggleComparativeAnalysisBtn.addEventListener('click', () => {
            showComparative = !showComparative;
            toggleComparativeAnalysisBtn.innerHTML = showComparative ? 'Ocultar Comparativo' : 'Mostrar Comparativo';
            comparativeAnalysisSection.style.display = showComparative ? 'block' : 'none';
            if (showComparative) {
                dashboardContent.style.display = 'none'; // Oculta o dashboard ao mostrar o comparativo
                showDashboard = false;
                toggleComparativeAnalysisBtn.innerHTML = 'Mostrar Gráficos'; // Atualiza o texto do botão do dashboard
            } else {
                if (chartComparativoFrotas) chartComparativoFrotas.destroy(); // Destroi o gráfico comparativo ao ocultar
                comparativeStatusP.textContent = ''; // Limpa o status do comparativo
            }
        });
        
        // Botão para gerar o gráfico comparativo
        compareFrotasButton.addEventListener('click', renderComparativeChart);
    </script>
</body>
</html>